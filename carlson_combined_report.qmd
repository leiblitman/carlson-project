---
title: "Tucker Carlson's Audience: Combined Analysis"
subtitle: "PrimePanels + Connect Samples — Merged Dataset"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    toc-title: "Table of Contents"
    theme: flatly
    code-fold: true
    code-tools: true
    embed-resources: true
    fig-width: 9
    fig-height: 5.5
    fig-dpi: 150
execute:
  warning: false
  message: false
  echo: false
---

```{r}
#| label: setup
#| include: false

library(tidyverse)
library(kableExtra)
library(scales)
library(cluster)

# ── Shared theme ──────────────────────────────────────────────────────────────
theme_report <- function() {
  theme_minimal(base_size = 12) +
    theme(
      plot.title       = element_text(face = "bold", size = 13),
      plot.subtitle    = element_text(color = "grey40", size = 11),
      axis.title       = element_text(size = 11),
      panel.grid.minor = element_blank(),
      strip.text       = element_text(face = "bold"),
      legend.position  = "bottom"
    )
}

pal_main <- c("#2c7bb6", "#d7191c", "#1a9641", "#fdae61", "#756bb1")
pal_src  <- c("PrimePanels" = "#2c7bb6", "Connect" = "#d7191c")

sig_star <- function(p) {
  case_when(
    p < .001 ~ "***", p < .01 ~ "**", p < .05 ~ "*", p < .10 ~ "†", TRUE ~ ""
  )
}

# ── Load and combine ──────────────────────────────────────────────────────────
# Read all files as character to avoid type-inference conflicts between batches.
# Numeric conversion happens downstream with suppressWarnings(as.numeric(...)).
read_survey <- function(path, src) {
  read_csv(path, col_types = cols(.default = col_character()),
           show_col_types = FALSE) |>
    mutate(source = src)
}

pp_old <- read_survey("data/raw/result_persuasion_PrimePanels_2.17.26.csv",  "PrimePanels")
pp_new <- read_survey("data/raw/result_persuasion_PrimePanels_N91.17.27.csv", "PrimePanels")
con    <- read_survey("data/raw/result_persuasion_Connect_2.17.26.csv",        "Connect")

# Bind PrimePanels files; distinct() removes exact duplicate rows in case
# the newer export is cumulative and re-includes earlier responses.
pp <- bind_rows(pp_old, pp_new) |> distinct()

# Full combined raw dataset
df   <- bind_rows(pp, con)
df_c <- df |> filter(`Interview Status` == "Completed")

n_total    <- nrow(df)
n_complete <- nrow(df_c)
n_pp       <- sum(df_c$source == "PrimePanels")
n_con      <- sum(df_c$source == "Connect")

# ── Column helper ─────────────────────────────────────────────────────────────
fcol <- function(pattern, data = df, suffix = NULL) {
  nms <- grep(pattern, names(data), value = TRUE, perl = TRUE)
  if (!is.null(suffix)) nms <- grep(suffix, nms, value = TRUE, fixed = TRUE)
  nms
}

# ── Pre-treatment columns (same Q numbers in both sources) ────────────────────
# Q7 = conspiracy | Q8 = Carlson cred | Q9 = FP | Q10 = therm | Q11 = TC-Israel | Q12 = Israel policy
con_cols       <- fcol("^\\(7\\.[0-9]\\).*- Code$",  data = df_c)
cred_pre_cols  <- fcol("^\\(8\\.[0-9]\\).*- Value$", data = df_c)
fp_pre_cols    <- fcol("^\\(9\\.[0-9]\\).*- Value$", data = df_c)
therm_pre_cols <- fcol("^\\(10\\.[0-9]\\).*- Value$",data = df_c)
tc_pre_cols    <- fcol("^\\(11\\.[0-9]\\).*- Value$",data = df_c)
ip_pre_cols    <- fcol("^\\(12\\.[0-9]\\).*- Value$",data = df_c)

# ── Standardise post-treatment columns ───────────────────────────────────────
# PrimePanels post = Q18–Q22 | Connect post = Q17–Q21 (shifted by 1).
#
# The combined dataset contains BOTH sources' Q18 columns (PP cred post and
# Connect FP post have different question text → different column names).
# Grepping the merged data would find both and cause a count mismatch.
# Fix: grep each source file individually BEFORE merging so the lists are
# unambiguous, then use them in add_post() after merging.

gq <- function(q, nm) grep(paste0("^\\(", q, "\\.[0-9]+\\).*- Value$"), nm, value = TRUE)

pp_post_cred  <- gq(18, names(pp_old));  con_post_cred  <- gq(17, names(con))
pp_post_fp    <- gq(19, names(pp_old));  con_post_fp    <- gq(18, names(con))
pp_post_therm <- gq(20, names(pp_old));  con_post_therm <- gq(19, names(con))
pp_post_tc    <- gq(21, names(pp_old));  con_post_tc    <- gq(20, names(con))
pp_post_ip    <- gq(22, names(pp_old));  con_post_ip    <- gq(21, names(con))

# add_post() now receives the pre-computed, source-specific column vectors.
add_post <- function(data, domain_name, pp_src_cols, con_src_cols) {
  for (i in seq_along(pp_src_cols)) {
    new_col <- paste0("post_", domain_name, "_", i)
    data[[new_col]] <- if_else(
      data$source == "PrimePanels",
      suppressWarnings(as.numeric(data[[pp_src_cols[i]]])),
      suppressWarnings(as.numeric(data[[con_src_cols[i]]]))
    )
  }
  data
}

df_c <- df_c |>
  add_post("cred",  pp_post_cred,  con_post_cred)  |>
  add_post("fp",    pp_post_fp,    con_post_fp)    |>
  add_post("therm", pp_post_therm, con_post_therm) |>
  add_post("tc",    pp_post_tc,    con_post_tc)    |>
  add_post("ip",    pp_post_ip,    con_post_ip)

cred_post_cols  <- paste0("post_cred_",  seq_along(cred_pre_cols))
fp_post_cols    <- paste0("post_fp_",    seq_along(fp_pre_cols))
therm_post_cols <- paste0("post_therm_", seq_along(therm_pre_cols))
tc_post_cols    <- paste0("post_tc_",    seq_along(tc_pre_cols))
ip_post_cols    <- paste0("post_ip_",    seq_along(ip_pre_cols))

# ── Paired t-test helper ──────────────────────────────────────────────────────
paired_stats <- function(pre_cols, post_cols, labels, data = df_c) {
  map2_dfr(pre_cols, post_cols, function(p, q) {
    pre_v  <- suppressWarnings(as.numeric(data[[p]]))
    post_v <- suppressWarnings(as.numeric(data[[q]]))
    ok     <- !is.na(pre_v) & !is.na(post_v)
    n      <- sum(ok)
    if (n < 3) return(tibble(n=n, pre=NA, post=NA, diff=NA, d=NA, p=NA))
    diffs <- post_v[ok] - pre_v[ok]
    tst   <- t.test(post_v[ok], pre_v[ok], paired = TRUE)
    tibble(n=n, pre=round(mean(pre_v[ok]),1), post=round(mean(post_v[ok]),1),
           diff=round(mean(diffs),1), d=round(mean(diffs)/sd(diffs),2),
           p=tst$p.value)
  }) |> mutate(Item = labels) |> relocate(Item)
}

fmt_pp_table <- function(tbl, caption = NULL) {
  tbl |>
    mutate(
      `Pre M`  = pre,
      `Post M` = post,
      `Δ`      = case_when(diff > 0 ~ paste0("+", diff), TRUE ~ as.character(diff)),
      d        = d,
      p        = paste0(format(round(p, 3), nsmall = 3), " ", sig_star(p))
    ) |>
    select(Item, n, `Pre M`, `Post M`, `Δ`, d, p) |>
    kbl(caption = caption, align = c("l","c","c","c","c","c","l")) |>
    kable_styling(bootstrap_options = c("striped","hover","condensed"),
                  full_width = FALSE, position = "left") |>
    footnote(general = "0–100 scales. d = Cohen's d. † p<.10, * p<.05, ** p<.01, *** p<.001.",
             general_title = "")
}

# ── Harmonised demographics ───────────────────────────────────────────────────
# PrimePanels demographics: survey-asked at Q26–Q35
# Connect demographics: panel-provided system columns + Q29 for ideology
age_col_pp    <- fcol("^\\(26\\) What is your age",                         data = df_c)[1]
gender_col_pp <- fcol("^\\(27\\) What is your gender",                      data = df_c)[1]
race_col_pp   <- fcol("^\\(29\\) What is your race",                        data = df_c)[1]
ideo_col_pp   <- fcol("^\\(30\\) Do you consider yourself politically",      data = df_c)[1]
party_col_pp  <- fcol("^\\(31\\) Do you consider yourself a Democrat",       data = df_c)[1]
inc_col_pp    <- fcol("^\\(32\\) What is your combined",                     data = df_c)[1]
educ_col_pp   <- fcol("^\\(33\\) What is the highest level",                 data = df_c)[1]

age_col_con   <- fcol("^Age \\(",               data = df_c)[1]
sex_col_con   <- fcol("^Sex \\(",               data = df_c)[1]
race_col_con  <- fcol("^Race \\(",              data = df_c)[1]
party_col_con <- fcol("^Political Party \\(",   data = df_c)[1]
ideo_col_con  <- fcol("^\\(29\\) Do you consider yourself politically", data = df_c)[1]
tc_panel_col  <- fcol("^Tucker Carlson Content \\(", data = df_c)[1]

# Shared survey Q3: viewing frequency (both sources)
tc_freq_col <- fcol("^\\(3\\) How often do you watch", data = df_c)[1]

ideo_order <- c("Very liberal","Somewhat liberal","Moderate",
                "Somewhat conservative","Very conservative")

demo <- df_c |>
  mutate(
    source = source,

    # Age: numeric from Connect panel; category from PrimePanels survey
    age_num = if_else(source == "Connect",
                      suppressWarnings(as.numeric(.data[[age_col_con]])),
                      NA_real_),
    age_group = case_when(
      source == "PrimePanels" ~ .data[[age_col_pp]],
      !is.na(age_num) ~ case_when(
        age_num < 30 ~ "18–29", age_num < 40 ~ "30–39",
        age_num < 50 ~ "40–49", age_num < 60 ~ "50–59",
        age_num < 70 ~ "60–69", TRUE ~ "70+"
      )
    ),

    # Gender / sex
    gender_sex = case_when(
      source == "PrimePanels" ~ .data[[gender_col_pp]],
      source == "Connect"     ~ .data[[sex_col_con]]
    ),

    # Race
    race_raw = case_when(
      source == "PrimePanels" ~ .data[[race_col_pp]],
      source == "Connect"     ~ .data[[race_col_con]]
    ),
    race_grp = case_when(
      grepl("White", race_raw, ignore.case = TRUE) ~ "White",
      !is.na(race_raw) ~ "Non-White",
      TRUE ~ NA_character_
    ),

    # Ideology (PrimePanels Q30, Connect Q29 — same question text)
    ideology = case_when(
      source == "PrimePanels" ~ .data[[ideo_col_pp]],
      source == "Connect"     ~ .data[[ideo_col_con]]
    ),
    ideo_num = case_when(
      ideology == "Very liberal"          ~ 1,
      ideology == "Somewhat liberal"      ~ 2,
      ideology == "Moderate"              ~ 3,
      ideology == "Somewhat conservative" ~ 4,
      ideology == "Very conservative"     ~ 5,
      TRUE ~ NA_real_
    ),

    # Party (PrimePanels Q31, Connect panel)
    party_raw = case_when(
      source == "PrimePanels" ~ .data[[party_col_pp]],
      source == "Connect"     ~ .data[[party_col_con]]
    ),
    party3 = case_when(
      grepl("Republican",  party_raw, ignore.case = TRUE) ~ "Republican",
      grepl("Democrat",    party_raw, ignore.case = TRUE) ~ "Democrat",
      !is.na(party_raw) ~ "Ind./Other",
      TRUE ~ NA_character_
    ),

    # Viewing frequency (survey Q3, both sources)
    tc_freq = .data[[tc_freq_col]],
    tc_short = case_when(
      grepl("every day|several.*week|every week", tc_freq, ignore.case = TRUE) ~ "Regular viewer",
      grepl("occasionally|rarely|few times",      tc_freq, ignore.case = TRUE) ~ "Occasional viewer",
      !is.na(tc_freq) ~ "Other",
      TRUE ~ NA_character_
    )
  ) |>
  select(source, age_num, age_group, gender_sex, race_raw, race_grp,
         ideology, ideo_num, party_raw, party3, tc_freq, tc_short)
```

::: {.callout-warning}
## Pilot Data — Treat All Results as Preliminary
This report combines **`r n_complete` completed responses** across two data sources: **`r n_pp` from PrimePanels** and **`r n_con` from Connect** (CloudResearch). Both datasets were collected in February 2026 as pilot studies. Statistical results should be treated as exploratory pending full-scale replication.
:::

::: {.callout-note}
## How the Two Sources Were Combined

| Feature | PrimePanels | Connect |
|---|---|---|
| Recruitment | PrimePanels panel | CloudResearch Connect |
| Post-treatment Q numbers | Q18–Q22 | Q17–Q21 |
| Age variable | Survey-asked (category) | Panel-provided (numeric) |
| Party variable | Survey Q31 | Panel-provided |
| Ideology variable | Survey Q30 | Survey Q29 |
| N completed | `r n_pp` | `r n_con` |

Post-treatment column numbers were harmonised at load time so that pre–post comparisons use the correct question pairs for each respondent's source.
:::

---

# 1 Sample Overview

```{r}
#| label: tbl-sample-overview
#| tbl-cap: "Sample composition by data source"

tibble(
  Source        = c("PrimePanels", "Connect", "**Total**"),
  `Total rows`  = c(nrow(pp), nrow(con), nrow(df)),
  `Completed`   = c(n_pp, n_con, n_complete),
  `Completion %`= paste0(round(c(n_pp/nrow(pp), n_con/nrow(con),
                                  n_complete/nrow(df))*100, 0), "%")
) |>
  kbl(escape = FALSE) |>
  kable_styling(bootstrap_options = c("striped","hover","condensed"),
                full_width = FALSE, position = "left")
```

---

# 2 Sample Characteristics

## 2.1 Demographics by Source

```{r}
#| label: fig-age-by-source
#| fig-height: 4
#| fig-cap: "Age group distribution by source. PrimePanels age is survey-asked (categorical); Connect age is panel-provided (converted to groups)."

demo |>
  filter(!is.na(age_group)) |>
  count(source, age_group) |>
  group_by(source) |>
  mutate(pct = n / sum(n),
         age_group = factor(age_group,
                            levels = c("18–29","30–39","40–49",
                                       "50–59","60–69","70+"))) |>
  ungroup() |>
  ggplot(aes(x = age_group, y = pct, fill = source)) +
  geom_col(position = "dodge", width = 0.7) +
  geom_text(aes(label = percent(pct, 1)),
            position = position_dodge(0.7), vjust = -0.4, size = 3) +
  scale_fill_manual(values = pal_src, name = "Source") +
  scale_y_continuous(labels = percent, expand = expansion(mult = c(0, 0.2))) +
  labs(title = "Age Group Distribution by Source",
       x = "Age Group", y = NULL) +
  theme_report()
```

```{r}
#| label: fig-demographics
#| fig-height: 10
#| fig-cap: "Demographic profile of all completed respondents (both sources combined)"

demo_long <- bind_rows(
  demo |> count(Category = age_group,  Variable = "Age Group"),
  demo |> count(Category = gender_sex, Variable = "Gender / Sex at Birth"),
  demo |> count(Category = race_grp,   Variable = "Race (grouped)"),
  demo |> count(Category = party3,     Variable = "Party"),
  demo |> count(Category = ideology,   Variable = "Political Ideology"),
  demo |> count(Category = tc_short,   Variable = "Viewing Frequency")
) |>
  filter(!is.na(Category)) |>
  group_by(Variable) |>
  mutate(pct = n / sum(n), Category = fct_reorder(Category, n)) |>
  ungroup() |>
  mutate(Variable = factor(Variable, levels = c(
    "Age Group", "Gender / Sex at Birth", "Race (grouped)",
    "Party", "Political Ideology", "Viewing Frequency"
  )))

ggplot(demo_long, aes(x = Category, y = pct)) +
  geom_col(fill = "#2c7bb6", width = 0.7) +
  geom_text(aes(label = paste0(n, " (", percent(pct, 1), ")")),
            hjust = -0.1, size = 3) +
  scale_y_continuous(labels = percent, expand = expansion(mult = c(0, 0.45))) +
  coord_flip() +
  facet_wrap(~Variable, scales = "free", ncol = 2) +
  labs(title = "Combined Sample Demographics",
       subtitle = paste0("All completed respondents (n = ", n_complete, ")"),
       x = NULL, y = NULL) +
  theme_report()
```

## 2.2 Political Composition by Source

```{r}
#| label: fig-party-by-source
#| fig-height: 4
#| fig-cap: "Party and ideology distributions by source"

bind_rows(
  demo |> filter(!is.na(party3)) |>
    count(source, Category = party3) |>
    group_by(source) |> mutate(pct = n/sum(n)) |>
    ungroup() |> mutate(Variable = "Party"),
  demo |> filter(!is.na(ideology)) |>
    count(source, Category = ideology) |>
    group_by(source) |> mutate(pct = n/sum(n)) |>
    ungroup() |>
    mutate(Variable = "Ideology",
           Category = factor(Category, levels = ideo_order))
) |>
  ggplot(aes(x = Category, y = pct, fill = source)) +
  geom_col(position = "dodge", width = 0.7) +
  geom_text(aes(label = percent(pct, 1)),
            position = position_dodge(0.7), vjust = -0.4, size = 2.8) +
  scale_fill_manual(values = pal_src, name = "Source") +
  scale_y_continuous(labels = percent, expand = expansion(mult = c(0, 0.25))) +
  coord_flip() +
  facet_wrap(~Variable, scales = "free", ncol = 2) +
  labs(title = "Political Composition by Source",
       x = NULL, y = "Proportion within source") +
  theme_report()
```

```{r}
#| label: tbl-demographics
#| tbl-cap: "Demographic summary by source and combined"

summarise_demo <- function(d) {
  tibble(
    `n completed`        = nrow(d),
    `% Republican`       = paste0(round(mean(d$party3 == "Republican", na.rm=T)*100,0), "%"),
    `% Democrat`         = paste0(round(mean(d$party3 == "Democrat",   na.rm=T)*100,0), "%"),
    `% Ind./Other`       = paste0(round(mean(d$party3 == "Ind./Other", na.rm=T)*100,0), "%"),
    `% Conservative`     = paste0(round(mean(d$ideology %in%
                             c("Very conservative","Somewhat conservative"),
                             na.rm=T)*100,0), "%"),
    `% White`            = paste0(round(mean(d$race_grp == "White", na.rm=T)*100,0), "%"),
    `Mean age (Connect)` = if (any(d$source == "Connect"))
                             round(mean(d$age_num[d$source == "Connect"], na.rm=T), 1)
                           else NA_real_
  )
}

bind_rows(
  summarise_demo(demo |> filter(source == "PrimePanels")),
  summarise_demo(demo |> filter(source == "Connect")),
  summarise_demo(demo)
) |>
  mutate(Source = c("PrimePanels", "Connect", "**Combined**")) |>
  relocate(Source) |>
  kbl(escape = FALSE) |>
  kable_styling(bootstrap_options = c("striped","hover","condensed"),
                full_width = TRUE) |>
  footnote(general = "Conservative = Very or Somewhat conservative. Mean age uses Connect numeric age only (PrimePanels age is categorical).",
           general_title = "")
```

---

# 3 Tucker Carlson Engagement

```{r}
#| label: fig-viewing
#| fig-height: 3.5
#| fig-cap: "Viewing frequency by source (survey Q3)"

df |>
  mutate(freq = .data[[tc_freq_col]]) |>
  filter(!is.na(freq)) |>
  count(source, freq) |>
  group_by(source) |>
  mutate(pct = n / sum(n), freq = fct_reorder(freq, n)) |>
  ungroup() |>
  ggplot(aes(x = freq, y = pct, fill = source)) +
  geom_col(position = "dodge", width = 0.7) +
  geom_text(aes(label = percent(pct, 1)),
            position = position_dodge(0.7), hjust = -0.1, size = 3) +
  scale_fill_manual(values = pal_src, name = "Source") +
  scale_y_continuous(labels = percent, expand = expansion(mult = c(0, 0.3))) +
  coord_flip() +
  labs(title = "Tucker Carlson Viewing Frequency",
       subtitle = "All respondents (N = " %+% n_total %+% ")",
       x = NULL, y = NULL) +
  theme_report()
```

```{r}
#| label: fig-commentators
#| fig-height: 4
#| fig-cap: "Commentator credibility ratings (0 = should be ignored, 100 = should be listened to)"

comm_cols   <- fcol("^\\(2\\.[0-9]\\).*- Value$", data = df)
comm_labels <- c("Tucker Carlson","Cenk Uygur","Ben Shapiro",
                 "Hasan Piker","Scott Jennings")

map2_dfr(comm_cols[seq_along(comm_labels)], comm_labels, function(col, lab) {
  vals <- suppressWarnings(as.numeric(df[[col]]))
  tibble(Commentator = lab, Mean = round(mean(vals, na.rm=T),1),
         SD = round(sd(vals, na.rm=T),1), N = sum(!is.na(vals)))
}) |>
  arrange(Mean) |>
  mutate(Commentator = fct_reorder(Commentator, Mean),
         color = ifelse(Commentator == "Tucker Carlson","#d7191c","#2c7bb6")) |>
  ggplot(aes(x = Commentator, y = Mean, color = color)) +
  geom_segment(aes(xend = Commentator, y = 0, yend = Mean), linewidth = 1.2) +
  geom_point(size = 5) +
  geom_errorbar(aes(ymin = Mean - SD/sqrt(N), ymax = Mean + SD/sqrt(N)),
                width = 0.2, color = "grey50") +
  geom_text(aes(label = Mean), vjust = -1.2, fontface = "bold",
            size = 3.8, color = "black") +
  scale_y_continuous(limits = c(0, 110), breaks = seq(0,100,25)) +
  scale_color_identity() +
  coord_flip() +
  labs(title = "Commentator Credibility Ratings",
       subtitle = paste0("All respondents (N = ", n_total, ")"),
       x = NULL, y = "Mean Rating (0–100)") +
  theme_report()
```

---

# 4 Baseline Beliefs and Attitudes

## 4.1 Conspiracy and Fringe Beliefs

```{r}
#| label: fig-conspiracy
#| fig-height: 5
#| fig-cap: "Conspiracy / fringe belief endorsement (Q7, 1–5 scale)"

con_labels <- c("Vaccines dangerous\nfor children",
                "Moon landing\nwas staged",
                "Epstein was a\nMossad agent",
                "Gov't hiding\nalien contact",
                "2020 election\nwas stolen")

map2_dfr(con_cols, con_labels, function(col, lab) {
  tibble(item = lab, value = suppressWarnings(as.numeric(df[[col]])))
}) |>
  filter(!is.na(value)) |>
  mutate(value = factor(value, 1:5,
                        labels = c("1\nStr. Disagree","2","3\nNeutral","4","5\nStr. Agree"))) |>
  count(item, value) |>
  group_by(item) |> mutate(pct = n/sum(n)) |> ungroup() |>
  ggplot(aes(x = value, y = pct, fill = value)) +
  geom_col(width = 0.7, show.legend = FALSE) +
  geom_text(aes(label = percent(pct, 1)), vjust = -0.4, size = 3) +
  scale_y_continuous(labels = percent, expand = expansion(mult = c(0, 0.2))) +
  scale_fill_manual(values = c("#2c7bb6","#74add1","#ffffbf","#f46d43","#d73027")) +
  facet_wrap(~item, ncol = 3) +
  labs(title = "Conspiracy and Fringe Belief Endorsement",
       subtitle = paste0("Combined sample (N = ", n_total, ")"),
       x = NULL, y = "Proportion") +
  theme_report()
```

## 4.2 Foreign Policy Views (Pre-Treatment)

```{r}
#| label: fig-fp-pre
#| fig-height: 3.5
#| fig-cap: "Foreign policy baseline attitudes (Q9, 0–100)"

fp_labels <- c("Russia provoked\nby NATO & West",
               "Israel & AIPAC have\ntoo much influence",
               "Cut all\nforeign funding")

map2_dfr(fp_pre_cols, fp_labels, function(col, lab) {
  tibble(item = lab, value = suppressWarnings(as.numeric(df[[col]])))
}) |>
  filter(!is.na(value)) |>
  group_by(item) |>
  summarise(M = round(mean(value),1), SD = round(sd(value),1), N = n()) |>
  mutate(item = fct_reorder(item, M)) |>
  ggplot(aes(x = M, y = item)) +
  geom_segment(aes(xend = M, x = 50, yend = item), color = "grey70") +
  geom_errorbarh(aes(xmin = M - 1.96*SD/sqrt(N), xmax = M + 1.96*SD/sqrt(N)),
                 height = 0.2, color = "#2c7bb6") +
  geom_point(size = 5, color = "#2c7bb6") +
  geom_text(aes(label = M), vjust = -1.2, fontface = "bold", size = 3.8) +
  geom_vline(xintercept = 50, linetype = "dashed", color = "grey60") +
  scale_x_continuous(limits = c(0,100), breaks = c(0,25,50,75,100)) +
  labs(title = "Foreign Policy Baseline (Q9)",
       subtitle = "0 = Strongly Disagree  |  100 = Strongly Agree  |  dashed = midpoint",
       x = "Mean Score (0–100)", y = NULL) +
  theme_report()
```

## 4.3 Feeling Thermometers (Pre-Treatment)

```{r}
#| label: fig-therm-pre
#| fig-height: 4
#| fig-cap: "Feeling thermometers toward Israel and Jewish people (Q10, 0–100)"

therm_labels <- c("Israeli People","Jewish People","State of Israel")

therm_data <- map2_dfr(therm_pre_cols, therm_labels, function(col, lab) {
  tibble(item = lab, value = suppressWarnings(as.numeric(df[[col]])))
}) |> filter(!is.na(value))

therm_summary <- therm_data |>
  group_by(item) |>
  summarise(M = round(mean(value),1), SD = round(sd(value),1),
            Md = round(median(value),1), N = n())

therm_data |>
  ggplot(aes(x = value, fill = item)) +
  geom_density(alpha = 0.6, color = "white") +
  geom_vline(data = therm_summary,
             aes(xintercept = M, color = item), linetype = "dashed",
             linewidth = 1, show.legend = FALSE) +
  scale_x_continuous(limits = c(0,100), breaks = c(0,25,50,75,100)) +
  scale_fill_manual(values = pal_main[1:3], name = NULL) +
  scale_color_manual(values = pal_main[1:3]) +
  labs(title = "Feeling Thermometers (Q10)",
       subtitle = "Dashed lines = group means",
       x = "0 = Extremely Unfavorable → 100 = Extremely Favorable", y = "Density") +
  theme_report()
```

```{r}
therm_summary |>
  kbl(caption = "Feeling thermometer descriptives (pre-treatment, combined sample)") |>
  kable_styling(bootstrap_options = c("striped","hover","condensed"),
                full_width = FALSE, position = "left")
```

---

# 5 Pre- to Post-Treatment Attitude Changes

> Post-treatment batteries: **Q18–Q22 for PrimePanels**, **Q17–Q21 for Connect**. Canonical post columns were created at load time so that each respondent's change is computed using the correct question for their source.

## 5.1 Carlson Credibility

```{r}
#| label: tbl-cred
#| tbl-cap: "Tucker Carlson credibility: pre (Q8) vs. post"

cred_labels <- c("Trusts his foreign policy analysis",
                 "He almost always gets the facts right",
                 "His predictions are usually accurate",
                 "Covers important topics others ignore",
                 "Effectively challenges mainstream narratives",
                 "He often gets things wrong")

fmt_pp_table(paired_stats(cred_pre_cols, cred_post_cols, cred_labels),
             "Carlson Credibility (0–100)")
```

## 5.2 Foreign Policy Views

```{r}
#| label: tbl-fp
#| tbl-cap: "Foreign policy views: pre (Q9) vs. post"

fp_pp_labels <- c("Russia was provoked by NATO and the West",
                  "Israel and AIPAC have too much influence over America",
                  "We should cut all funding to foreign countries")

fmt_pp_table(paired_stats(fp_pre_cols, fp_post_cols, fp_pp_labels),
             "Foreign Policy Views (0–100)")
```

## 5.3 Feeling Thermometers

```{r}
#| label: tbl-therm
#| tbl-cap: "Feeling thermometers: pre (Q10) vs. post"

therm_pp_labels <- c("Israeli people", "Jewish people", "The State of Israel")

fmt_pp_table(paired_stats(therm_pre_cols, therm_post_cols, therm_pp_labels),
             "Feeling Thermometers (0–100)")
```

## 5.4 Tucker Carlson's Israel Commentary

```{r}
#| label: tbl-tc
#| tbl-cap: "Perceptions of Tucker Carlson's Israel commentary: pre (Q11) vs. post"

tc_labels <- c("His commentary on Israel is accurate and fair",
               "He asks the right questions about America's relationship with Israel",
               "He is too critical of Israel",
               "He understands the Middle East better than most commentators")

fmt_pp_table(paired_stats(tc_pre_cols, tc_post_cols, tc_labels),
             "Carlson on Israel (0–100)")
```

## 5.5 Israel Policy Positions

```{r}
#| label: tbl-ip
#| tbl-cap: "Israel policy views: pre (Q12) vs. post"

ip_labels <- c("The U.S.–Israel relationship benefits the United States",
               "Israel has a legitimate right to exist as a Jewish state",
               "Israel generally acts morally in its self-defense",
               "The U.S. should reduce military aid to Israel")

fmt_pp_table(paired_stats(ip_pre_cols, ip_post_cols, ip_labels),
             "Israel Policy Views (0–100)")
```

## 5.6 Summary: Forest Plot of All Pre/Post Changes

```{r}
#| label: fig-forest
#| fig-height: 9
#| fig-cap: "All 20 pre–post mean changes with approximate 95% CIs. Red = p < .05; orange = p < .10."

all_pre_cols  <- c(cred_pre_cols,  fp_pre_cols,  therm_pre_cols,  tc_pre_cols,  ip_pre_cols)
all_post_cols <- c(cred_post_cols, fp_post_cols, therm_post_cols, tc_post_cols, ip_post_cols)
all_labels    <- c(cred_labels, fp_pp_labels, therm_pp_labels, tc_labels, ip_labels)
all_domains   <- c(rep("Carlson Credibility",6), rep("Foreign Policy",3),
                   rep("Feeling Thermometers",3), rep("Carlson on Israel",4),
                   rep("Israel Policy",4))

forest_data <- paired_stats(all_pre_cols, all_post_cols, all_labels) |>
  mutate(
    domain = all_domains,
    sig    = case_when(p < .05 ~ "p < .05", p < .10 ~ "p < .10", TRUE ~ "n.s."),
    se     = ifelse(!is.na(d) & d != 0, abs(diff/d)/sqrt(n), NA),
    lo     = diff - 1.96*se, hi = diff + 1.96*se,
    Item   = fct_rev(factor(Item, levels = rev(unique(Item)))),
    domain = factor(domain, levels = c("Carlson Credibility","Foreign Policy",
                                       "Feeling Thermometers","Carlson on Israel",
                                       "Israel Policy"))
  )

ggplot(forest_data, aes(x = diff, y = Item, color = sig)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") +
  geom_errorbarh(aes(xmin = lo, xmax = hi), height = 0.3, linewidth = 0.8) +
  geom_point(size = 3.5) +
  scale_color_manual(
    values = c("p < .05" = "#d7191c", "p < .10" = "#fdae61", "n.s." = "#aaaaaa"),
    name = "Significance"
  ) +
  facet_grid(domain ~ ., scales = "free_y", space = "free_y") +
  labs(title = "Pre → Post Mean Changes — Combined Sample",
       subtitle = paste0("n = ", n_complete, " completed  |  bars = approx. 95% CI"),
       x = "Mean Change (Post − Pre)", y = NULL) +
  theme_report() +
  theme(strip.text.y = element_text(angle = 0, hjust = 0))
```

## 5.7 Pre/Post Changes by Source

```{r}
#| label: fig-forest-by-source
#| fig-height: 9
#| fig-cap: "Mean pre–post change by source (PrimePanels vs. Connect). Points = mean Δ; bars = 95% CI."

forest_src <- bind_rows(
  paired_stats(all_pre_cols, all_post_cols, all_labels,
               data = df_c |> filter(source == "PrimePanels")) |>
    mutate(source = "PrimePanels"),
  paired_stats(all_pre_cols, all_post_cols, all_labels,
               data = df_c |> filter(source == "Connect")) |>
    mutate(source = "Connect")
) |>
  mutate(
    domain = rep(all_domains, 2),
    se     = ifelse(!is.na(d) & d != 0, abs(diff/d)/sqrt(n), NA),
    lo = diff - 1.96*se, hi = diff + 1.96*se,
    Item   = fct_rev(factor(Item, levels = rev(unique(Item)))),
    domain = factor(domain, levels = c("Carlson Credibility","Foreign Policy",
                                       "Feeling Thermometers","Carlson on Israel",
                                       "Israel Policy"))
  )

ggplot(forest_src, aes(x = diff, y = Item, color = source, shape = source)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") +
  geom_errorbarh(aes(xmin = lo, xmax = hi), height = 0.3, linewidth = 0.7,
                 position = position_dodge(0.6)) +
  geom_point(size = 3, position = position_dodge(0.6)) +
  scale_color_manual(values = pal_src, name = "Source") +
  scale_shape_manual(values = c(16, 17), name = "Source") +
  facet_grid(domain ~ ., scales = "free_y", space = "free_y") +
  labs(title = "Pre → Post Changes by Source",
       subtitle = "Points = mean Δ; bars = 95% CI",
       x = "Mean Change (Post − Pre)", y = NULL) +
  theme_report() +
  theme(strip.text.y = element_text(angle = 0, hjust = 0))
```

---

# 6 Audience Segmentation (Baseline Clusters)

```{r}
#| label: clustering-prep
#| include: false

# Feature matrix: pre-treatment Q7–Q12 (same Q numbers in both sources)
cluster_cols <- c(con_cols, fp_pre_cols, therm_pre_cols, tc_pre_cols, ip_pre_cols)

clust_raw <- df |>
  select(all_of(cluster_cols)) |>
  mutate(across(everything(), ~suppressWarnings(as.numeric(.x))))

clust_mat <- clust_raw |>
  mutate(across(everything(),
                ~ifelse(is.na(.x), median(.x, na.rm = TRUE), .x))) |>
  as.matrix()

clust_scaled <- apply(clust_mat, 2, function(x) {
  rng <- range(x, na.rm = TRUE)
  if (diff(rng) == 0) return(rep(0, length(x)))
  (x - rng[1]) / diff(rng)
})

set.seed(42)
sil_scores <- map_dbl(2:6, function(k) {
  km <- kmeans(clust_scaled, centers = k, nstart = 25, iter.max = 100)
  ss <- silhouette(km$cluster, dist(clust_scaled))
  mean(ss[, 3])
})

# Force k = 2 for consistency with narrative and palette
best_k   <- 2L
km_final <- kmeans(clust_scaled, centers = best_k, nstart = 50, iter.max = 100)

completed_idx    <- which(df[["Interview Status"]] == "Completed")
baseline_cl_comp <- factor(km_final$cluster[completed_idx])

demo <- demo |> mutate(baseline_cluster = baseline_cl_comp)
n_cl1 <- sum(baseline_cl_comp == 1)
n_cl2 <- sum(baseline_cl_comp == 2)
```

```{r}
#| label: fig-sil
#| fig-height: 3.5
#| fig-cap: "Silhouette analysis: k = 2 used for narrative consistency"

tibble(k = 2:6, silhouette = sil_scores) |>
  ggplot(aes(x = k, y = silhouette)) +
  geom_line(color = "#2c7bb6", linewidth = 1.2) +
  geom_point(size = 4, color = "#2c7bb6") +
  geom_point(data = tibble(k = best_k, silhouette = sil_scores[best_k - 1]),
             size = 6, shape = 21, color = "#d7191c", fill = NA, stroke = 2) +
  scale_x_continuous(breaks = 2:6) +
  labs(title = "Silhouette Analysis — Baseline Attitude Clusters",
       subtitle = "k = 2 used (forced; circled in red)",
       x = "k", y = "Mean Silhouette Score") +
  theme_report()
```

```{r}
#| label: fig-cluster-pca
#| fig-height: 5.5
#| fig-cap: "Baseline audience clusters projected onto first two principal components"

pca_res <- prcomp(clust_scaled, center = TRUE, scale. = FALSE)
pca_df  <- as_tibble(pca_res$x[, 1:2]) |>
  mutate(cluster = factor(km_final$cluster))
var_exp <- round(summary(pca_res)$importance[2, 1:2] * 100, 1)

pca_df |>
  ggplot(aes(x = PC1, y = PC2, color = cluster, shape = cluster)) +
  stat_ellipse(alpha = 0.12, aes(fill = cluster), geom = "polygon", type = "norm") +
  geom_point(size = 2.5, alpha = 0.8) +
  scale_color_manual(values = c("#2c7bb6","#d7191c"), name = "Cluster",
                     labels = c("1"="Cluster 1: Pro-Israel Conservatives",
                                "2"="Cluster 2: Skeptical Populists")) +
  scale_fill_manual( values = c("#2c7bb6","#d7191c"), name = "Cluster",
                     labels = c("1"="Cluster 1: Pro-Israel Conservatives",
                                "2"="Cluster 2: Skeptical Populists")) +
  scale_shape_manual(values = c(16,17), name = "Cluster",
                     labels = c("1"="Cluster 1: Pro-Israel Conservatives",
                                "2"="Cluster 2: Skeptical Populists")) +
  labs(title = paste0("Baseline Audience Segments (k = ", best_k, ", N = ", n_total, ")"),
       subtitle = paste0("PC1 = ", var_exp[1], "% variance; PC2 = ", var_exp[2], "%"),
       x = paste0("PC1 (", var_exp[1], "%)"),
       y = paste0("PC2 (", var_exp[2], "%)")) +
  theme_report()
```

```{r}
#| label: tbl-cluster-profiles
#| tbl-cap: "Baseline cluster mean profiles across all attitude dimensions (completed respondents)"

cl_item_labels <- c(
  "Vaccines dangerous","Moon landing staged",
  "Epstein/Mossad","Gov't hiding alien contact","2020 election stolen",
  "Russia provoked by NATO","Israel/AIPAC too influential","Cut all foreign funding",
  "Israeli people (therm.)","Jewish people (therm.)","State of Israel (therm.)",
  "Commentary accurate & fair","Asks right questions",
  "Too critical of Israel","Understands Middle East",
  "US-Israel benefits US","Israel right to exist",
  "Israel acts morally","Reduce military aid"
)
used_cl_labels <- cl_item_labels[seq_along(cluster_cols)]

as_tibble(clust_mat[completed_idx, ]) |>
  setNames(used_cl_labels) |>
  mutate(cluster = baseline_cl_comp) |>
  group_by(cluster) |>
  summarise(n = n(),
            across(all_of(used_cl_labels), ~round(mean(.x, na.rm=T), 1)),
            .groups = "drop") |>
  pivot_longer(-c(cluster, n), names_to = "Item", values_to = "Mean") |>
  pivot_wider(id_cols = "Item", names_from = cluster,
              values_from = Mean, names_prefix = "Cluster ") |>
  kbl(
    caption  = paste0("Cluster Profiles: Cluster 1 (n=", n_cl1,
                      ") vs. Cluster 2 (n=", n_cl2, ")"),
    col.names = c("Item",
                  paste0("Cluster 1\n(n=", n_cl1, ")"),
                  paste0("Cluster 2\n(n=", n_cl2, ")"))
  ) |>
  kable_styling(bootstrap_options = c("striped","hover","condensed"),
                full_width = FALSE, position = "left") |>
  pack_rows("Conspiracy Beliefs (1–5 scale)", 1, 5) |>
  pack_rows("Foreign Policy (0–100)", 6, 8) |>
  pack_rows("Feeling Thermometers (0–100)", 9, 11) |>
  pack_rows("Carlson on Israel (0–100)", 12, 15) |>
  pack_rows("Israel Policy (0–100)", 16, 19) |>
  footnote(general = "Conspiracy: 1=Str. Disagree, 5=Str. Agree. Others: 0–100 sliders.",
           general_title = "")
```

## 6.1 Cluster Demographics and Source Composition

```{r}
#| label: tbl-cluster-demo
#| tbl-cap: "Demographic and source composition by baseline cluster"

demo |>
  filter(!is.na(baseline_cluster)) |>
  group_by(`Cluster` = baseline_cluster) |>
  summarise(
    n                  = n(),
    `% PrimePanels`    = paste0(round(mean(source == "PrimePanels")*100, 0), "%"),
    `% Connect`        = paste0(round(mean(source == "Connect")*100,     0), "%"),
    `% Republican`     = paste0(round(mean(party3 == "Republican", na.rm=T)*100, 0), "%"),
    `% Democrat`       = paste0(round(mean(party3 == "Democrat",   na.rm=T)*100, 0), "%"),
    `% Conservative`   = paste0(round(mean(ideology %in%
                           c("Very conservative","Somewhat conservative"),
                           na.rm=T)*100, 0), "%"),
    `Mean Age`         = round(mean(age_num, na.rm=T), 1),
    .groups = "drop"
  ) |>
  kbl() |>
  kable_styling(bootstrap_options = c("striped","hover","condensed"),
                full_width = FALSE, position = "left") |>
  footnote(general = "Mean Age uses Connect numeric age only. % PrimePanels + % Connect ≈ 100%.",
           general_title = "")
```

```{r}
#| label: fig-cluster-by-source
#| fig-height: 3.5
#| fig-cap: "Cluster membership proportions by source"

demo |>
  filter(!is.na(baseline_cluster)) |>
  count(source, baseline_cluster) |>
  group_by(source) |>
  mutate(pct = n / sum(n)) |>
  ungroup() |>
  ggplot(aes(x = source, y = pct, fill = baseline_cluster)) +
  geom_col(width = 0.5) +
  geom_text(aes(label = paste0("Cl.", baseline_cluster, "\n", percent(pct, 1))),
            position = position_stack(vjust = 0.5),
            size = 4, fontface = "bold", color = "white") +
  scale_fill_manual(values = c("1" = "#2c7bb6","2" = "#d7191c"),
                    name = "Baseline Cluster") +
  scale_y_continuous(labels = percent) +
  labs(title = "Cluster Membership by Source",
       subtitle = "Both sources produce a similar 2-cluster split",
       x = "Source", y = "Proportion") +
  theme_report()
```

---

# 7 Change Score Analysis

```{r}
#| label: change-prep
#| include: false

ch_labels <- c(
  "Trust foreign policy",   "Gets facts right",    "Predictions accurate",
  "Covers ignored topics",  "Challenges narratives","Gets things wrong",
  "Russia provoked/NATO",   "Israel/AIPAC influence","Cut foreign funding",
  "Israeli people (therm.)","Jewish people (therm.)","State of Israel (therm.)",
  "Commentary accurate",    "Right questions",      "Too critical",
  "Understands Middle East",
  "US-Israel benefits US",  "Israel right to exist","Israel acts morally",
  "Reduce military aid"
)

ch_domains <- c(
  rep("Carlson Credibility",  6), rep("Foreign Policy",       3),
  rep("Feeling Thermometers", 3), rep("Carlson on Israel",    4),
  rep("Israel Policy",        4)
)

delta_mat <- map2_dfc(
  c(cred_pre_cols, fp_pre_cols, therm_pre_cols, tc_pre_cols, ip_pre_cols),
  c(cred_post_cols, fp_post_cols, therm_post_cols, tc_post_cols, ip_post_cols),
  function(p, q) suppressWarnings(as.numeric(df_c[[q]])) -
                 suppressWarnings(as.numeric(df_c[[p]]))
) |> setNames(ch_labels)

delta_full <- delta_mat |>
  mutate(
    baseline_cluster = baseline_cl_comp,
    source   = df_c$source,
    party3   = demo$party3,
    ideology = demo$ideology,
    ideo_num = demo$ideo_num,
    age_num  = demo$age_num,
    race_grp = demo$race_grp
  )

delta_long <- delta_full |>
  pivot_longer(all_of(ch_labels), names_to = "item", values_to = "delta") |>
  filter(!is.na(delta)) |>
  mutate(
    domain = ch_domains[match(item, ch_labels)],
    item   = factor(item, levels = ch_labels),
    domain = factor(domain, levels = c("Carlson Credibility","Foreign Policy",
                                       "Feeling Thermometers","Carlson on Israel",
                                       "Israel Policy"))
  )
```

## 7.1 Change Score Distributions

```{r}
#| label: fig-change-hist
#| fig-height: 10
#| fig-cap: "Distribution of pre-to-post change scores for all 20 items. Red dashed = mean Δ."

delta_long |>
  group_by(domain, item) |>
  mutate(M = mean(delta)) |>
  ungroup() |>
  ggplot(aes(x = delta)) +
  geom_histogram(binwidth = 10, fill = "#2c7bb6", color = "white", alpha = 0.8) +
  geom_vline(aes(xintercept = M), color = "#d7191c", linetype = "dashed", linewidth = 0.8) +
  geom_vline(xintercept = 0, color = "grey40", linewidth = 0.5) +
  scale_x_continuous(breaks = c(-50, 0, 50)) +
  facet_wrap(~item, ncol = 4, scales = "free_y") +
  labs(title = "Change Score Distributions (Δ = Post − Pre)",
       subtitle = "0 = no change  |  red dashed = mean Δ",
       x = "Δ (Post − Pre)", y = "Count") +
  theme_report() +
  theme(strip.text = element_text(size = 7))
```

```{r}
#| label: tbl-change-summary
#| tbl-cap: "Change score summary statistics for all outcome items"

delta_long |>
  group_by(Domain = domain, Item = item) |>
  summarise(n = n(), `Mean Δ` = round(mean(delta),1), SD = round(sd(delta),1),
            `% Δ>0` = paste0(round(mean(delta>0)*100,0),"%"),
            `% Δ<0` = paste0(round(mean(delta<0)*100,0),"%"),
            .groups = "drop") |>
  kbl() |>
  kable_styling(bootstrap_options = c("striped","hover","condensed"),
                full_width = FALSE, position = "left") |>
  collapse_rows(columns = 1, valign = "top") |>
  footnote(general = "% Δ>0 = proportion who increased; % Δ<0 = proportion who decreased.",
           general_title = "")
```

## 7.2 Change by Baseline Attitude Cluster

```{r}
#| label: fig-cluster-change
#| fig-height: 8
#| fig-cap: "Mean change score by baseline cluster"

delta_full |>
  pivot_longer(all_of(ch_labels), names_to = "item", values_to = "delta") |>
  filter(!is.na(delta)) |>
  mutate(domain = ch_domains[match(item, ch_labels)],
         item   = factor(item, levels = rev(ch_labels))) |>
  group_by(baseline_cluster, domain, item) |>
  summarise(M = mean(delta), SE = sd(delta)/sqrt(n()), .groups = "drop") |>
  mutate(domain = factor(domain, levels = c("Carlson Credibility","Foreign Policy",
                                            "Feeling Thermometers","Carlson on Israel",
                                            "Israel Policy"))) |>
  ggplot(aes(x = M, y = item, color = baseline_cluster, shape = baseline_cluster)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") +
  geom_errorbarh(aes(xmin = M - 1.96*SE, xmax = M + 1.96*SE),
                 height = 0.3, position = position_dodge(0.6)) +
  geom_point(size = 2.8, position = position_dodge(0.6)) +
  scale_color_manual(values = c("1"="#2c7bb6","2"="#d7191c"),
                     name = "Baseline cluster",
                     labels = c("1"="Cl. 1: Pro-Israel","2"="Cl. 2: Skeptical")) +
  scale_shape_manual(values = c(16,17), name = "Baseline cluster",
                     labels = c("1"="Cl. 1: Pro-Israel","2"="Cl. 2: Skeptical")) +
  facet_grid(domain ~ ., scales = "free_y", space = "free_y") +
  labs(title = "Mean Change by Baseline Attitude Cluster",
       subtitle = "Points = mean Δ; bars = 95% CI  |  0 = no change",
       x = "Mean Change (Post − Pre)", y = NULL) +
  theme_report() +
  theme(strip.text.y = element_text(angle = 0, hjust = 0),
        axis.text.y  = element_text(size = 8))
```

## 7.3 Cluster Analysis on Change Scores

```{r}
#| label: change-cluster-prep
#| include: false

delta_clust_mat <- delta_mat |>
  mutate(across(everything(), ~ifelse(is.na(.x), 0, .x))) |>
  as.matrix()

delta_scaled <- scale(delta_clust_mat)
delta_scaled[!is.finite(delta_scaled)] <- 0

set.seed(42)
delta_sil <- map_dbl(2:5, function(k) {
  km <- kmeans(delta_scaled, centers = k, nstart = 25, iter.max = 100)
  ss <- silhouette(km$cluster, dist(delta_scaled))
  mean(ss[, 3])
})

best_k_delta <- which.max(delta_sil) + 1L
km_delta     <- kmeans(delta_scaled, centers = best_k_delta,
                        nstart = 50, iter.max = 100)

n_ch1 <- sum(km_delta$cluster == 1)
n_ch2 <- sum(km_delta$cluster == 2)
```

```{r}
#| label: fig-change-sil
#| fig-height: 3.5
#| fig-cap: "Silhouette analysis for change-score clusters"

tibble(k = 2:5, silhouette = delta_sil) |>
  ggplot(aes(x = k, y = silhouette)) +
  geom_line(color = "#2c7bb6", linewidth = 1.2) +
  geom_point(size = 4, color = "#2c7bb6") +
  geom_point(data = tibble(k = best_k_delta, silhouette = max(delta_sil)),
             size = 6, shape = 21, color = "#d7191c", fill = NA, stroke = 2) +
  scale_x_continuous(breaks = 2:5) +
  labs(title = "Silhouette Analysis — Change-Score Clusters",
       subtitle = paste0("Best k = ", best_k_delta, " (circled)"),
       x = "k", y = "Mean Silhouette Score") +
  theme_report()
```

```{r}
#| label: fig-change-cluster-profiles
#| fig-height: 8
#| fig-cap: "Change cluster profiles across all 20 outcome items"

as_tibble(delta_clust_mat) |>
  mutate(change_cluster = factor(km_delta$cluster)) |>
  pivot_longer(all_of(ch_labels), names_to = "item", values_to = "delta") |>
  group_by(change_cluster, item) |>
  summarise(M = mean(delta), SE = sd(delta)/sqrt(n()), .groups = "drop") |>
  mutate(
    domain = ch_domains[match(item, ch_labels)],
    item   = factor(item, levels = rev(ch_labels)),
    domain = factor(domain, levels = c("Carlson Credibility","Foreign Policy",
                                       "Feeling Thermometers","Carlson on Israel",
                                       "Israel Policy"))
  ) |>
  ggplot(aes(x = M, y = item, color = change_cluster, shape = change_cluster)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey60") +
  geom_errorbarh(aes(xmin = M - 1.96*SE, xmax = M + 1.96*SE),
                 height = 0.3, position = position_dodge(0.6)) +
  geom_point(size = 2.8, position = position_dodge(0.6)) +
  scale_color_manual(values = pal_main[1:best_k_delta], name = "Change cluster") +
  scale_shape_manual(values = c(16,17,15,18)[1:best_k_delta], name = "Change cluster") +
  facet_grid(domain ~ ., scales = "free_y", space = "free_y") +
  labs(title = "Change Cluster Profiles",
       subtitle = "Points = mean Δ; bars = 95% CI  |  0 = no change",
       x = "Mean Change (Post − Pre)", y = NULL) +
  theme_report() +
  theme(strip.text.y = element_text(angle = 0, hjust = 0),
        axis.text.y  = element_text(size = 8))
```

```{r}
#| label: tbl-change-profile
#| tbl-cap: "Mean Δ by change cluster for all 20 outcome items"

as_tibble(delta_clust_mat) |>
  mutate(change_cluster = factor(km_delta$cluster)) |>
  group_by(change_cluster) |>
  summarise(n = n(), across(all_of(ch_labels), ~round(mean(.x, na.rm=T),1)),
            .groups = "drop") |>
  pivot_longer(-c(change_cluster, n), names_to = "Item", values_to = "Mean_delta") |>
  mutate(Domain    = ch_domains[match(Item, ch_labels)],
         col_label = paste0("Cluster ", change_cluster, "\n(n=", n, ")")) |>
  pivot_wider(id_cols = c(Domain, Item), names_from = col_label,
              values_from = Mean_delta) |>
  kbl(caption = paste0("Mean Δ by Change Cluster (k = ", best_k_delta, ")")) |>
  kable_styling(bootstrap_options = c("striped","hover","condensed"),
                full_width = TRUE) |>
  collapse_rows(columns = 1, valign = "top") |>
  footnote(general = "Δ = post − pre. Negative = decreased; positive = increased.",
           general_title = "")
```

```{r}
#| label: tbl-change-demo
#| tbl-cap: "Demographic composition of change clusters"

tibble(
  change_cluster = factor(km_delta$cluster),
  source   = df_c$source,
  party3   = demo$party3,
  ideology = demo$ideology,
  age_num  = demo$age_num
) |>
  group_by(`Change Cluster` = change_cluster) |>
  summarise(
    n               = n(),
    `% PrimePanels` = paste0(round(mean(source == "PrimePanels")*100, 0), "%"),
    `% Republican`  = paste0(round(mean(party3 == "Republican", na.rm=T)*100, 0), "%"),
    `% Conservative`= paste0(round(mean(ideology %in%
                        c("Very conservative","Somewhat conservative"),
                        na.rm=T)*100, 0), "%"),
    `Mean Age`      = round(mean(age_num, na.rm=T), 1),
    .groups = "drop"
  ) |>
  kbl() |>
  kable_styling(bootstrap_options = c("striped","hover","condensed"),
                full_width = FALSE, position = "left") |>
  footnote(general = "Mean Age uses Connect numeric age only.", general_title = "")
```

## 7.4 Cross-Tab: Baseline × Change Clusters

```{r}
#| label: tbl-crosstab
#| tbl-cap: "Cross-tabulation: baseline attitude cluster × change-score cluster"

xtab <- table(`Baseline` = baseline_cl_comp,
              `Change`   = factor(km_delta$cluster))
xtab_pct <- prop.table(xtab, margin = 1) * 100

as.data.frame.matrix(xtab) |>
  rownames_to_column("Baseline Cluster") |>
  rename_with(~paste0("Change Cl. ", .), -1) |>
  mutate(Total = rowSums(across(where(is.numeric))),
         `% in Change Cl.1` = paste0(round(xtab_pct[,1], 0), "%")) |>
  kbl(caption = "Cross-tab: Baseline × Change Clusters") |>
  kable_styling(bootstrap_options = c("striped","hover","condensed"),
                full_width = FALSE, position = "left") |>
  footnote(
    general = paste0("Fisher's exact test: p = ",
                     round(fisher.test(xtab)$p.value, 3)),
    general_title = ""
  )
```

---

# 8 Key Findings

```{r}
#| label: tbl-key-findings
#| tbl-cap: "Summary of principal findings — combined sample"

tibble(
  Finding = c(
    "Combined sample",
    "Source composition",
    "Political profile",
    "Baseline cluster structure",
    "Cluster 1: Pro-Israel Conservatives",
    "Cluster 2: Skeptical Populists",
    "Pre/post change — overall",
    "Change clusters",
    "Baseline × Change link"
  ),
  Result = c(
    paste0("n = ", n_complete, " completed responses (PP: ", n_pp, "; Connect: ", n_con, ")"),
    "Both panels recruited Tucker Carlson viewers; Connect draws from a broader, more politically diverse pool",
    paste0("Combined sample is predominantly Republican/conservative with ideological diversity from Connect respondents"),
    paste0("k = 2 baseline clusters identified; split approximately ", n_cl1, " (Pro-Israel) vs. ", n_cl2, " (Skeptical Populists)"),
    "Warm thermometers toward Israel (70s–80s), endorses Carlson's Israel framing, more Republican and conservative",
    "Cooler thermometers, higher AIPAC skepticism, more independent, higher conspiracy belief endorsement",
    "Carlson credibility items show the clearest pre–post declines; Israel policy and thermometers largely resistant to change",
    paste0("k = ", best_k_delta, " change clusters: a 'Persuaded' minority (n ≈ ", n_ch1,
           ") with large credibility drops vs. a 'Resistant' majority (n ≈ ", n_ch2, ") near zero change"),
    paste0("Fisher's exact test p = ", round(fisher.test(xtab)$p.value, 3),
           " — no significant association between starting position and change pattern")
  )
) |>
  kbl(escape = FALSE) |>
  kable_styling(bootstrap_options = c("striped","hover","condensed"),
                full_width = TRUE) |>
  column_spec(1, bold = TRUE, width = "28%") |>
  column_spec(2, width = "68%")
```

---

# Appendix: Technical Notes

**Data sources:** `result_persuasion_PrimePanels_2.17.26.csv`, `result_persuasion_PrimePanels_N91.17.27.csv`, and `result_persuasion_Connect_2.17.26.csv`. The two PrimePanels files are combined with `distinct()` to remove any exact duplicate rows that may exist if the newer export is cumulative.

**Post-treatment harmonisation:** Connect uses Q17–Q21 for post-treatment batteries; PrimePanels uses Q18–Q22. Canonical `post_<domain>_<i>` columns were created at load time using `if_else(source == "PrimePanels", ...)` to select the correct column for each row.

**Demographics:** Age (numeric) is available only for Connect respondents (panel-provided). PrimePanels age is survey-asked and stored as categorical bins; it is converted to matching bins for display but cannot be used in numeric correlations. Party affiliation uses PrimePanels survey Q31 and Connect's panel-provided variable, both recoded to Republican / Democrat / Ind./Other.

**Clustering:** K-means with 50 random starts on pre-treatment variables (Q7–Q12), which have identical question numbers in both sources. Baseline k forced to 2 for narrative consistency. Change-score k selected by silhouette. Missing change scores imputed as 0 (no change).

```{r}
#| label: session-info
#| echo: true
#| code-fold: true
#| code-summary: "Session Info"

sessionInfo()
```
